<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Caption Generator</title>
    <!-- Google Font: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom styles */
        body {
            /* Use Poppins as the default font */
            font-family: 'Poppins', sans-serif;
            
            /* Set a new light indigo background */
            background-color: #eef2ff; /* Tailwind 'indigo-50' */
        }

        /* Loading spinner animation */
        .spinner {
            border-top-color: #4f46e5; /* Indigo color */
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Drag-over effect */
        .drag-over {
            border-color: #4f46e5;
            background-color: #e0e7ff; /* Lighter indigo */
        }

        /* Hide the default file input */
        #file-upload {
            display: none;
        }

        /* Simple Pop-in Animation */
        .animate-pop-in {
            animation: popIn 0.4s ease-out;
        }

        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.95);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Main Card -->
    <main class="bg-white w-full max-w-lg rounded-2xl shadow-xl p-6 md:p-10 animate-pop-in">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">üñºÔ∏è Image Caption Generator</h1>
            <p class="text-lg text-gray-600 mt-2">Upload an image and let AI describe it for you</p>
        </header>

        <!-- Error Message Box -->
        <div id="error-box" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 px-4 py-3 rounded-lg relative my-4" role="alert">
            <strong class="font-bold">Error:</strong>
            <span class="block sm:inline" id="error-message">Something went wrong.</span>
        </div>

        <!-- 1. UPLOAD STATE -->
        <section id="upload-section" class="space-y-6">
            <!-- Drop Zone -->
            <label id="drop-zone" for="file-upload" class="flex flex-col items-center justify-center w-full h-64 border-4 border-dashed border-gray-200 rounded-2xl cursor-pointer hover:border-indigo-400 transition-colors duration-300 bg-gray-50 hover:bg-indigo-50">
                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                    <svg class="w-12 h-12 mb-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <p class="mb-2 text-lg text-gray-700 font-semibold">Drag & drop image here</p>
                    <p class="text-gray-500 text-sm">or</p>
                    <button type="button" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-all transform hover:scale-105 duration-300">
                        Browse Files
                    </button>
                    <p class="text-xs text-gray-500 mt-4">Supports: PNG, JPG, GIF (max 16MB)</p>
                </div>
            </label>
            <input id="file-upload" type="file" accept="image/*" />
        </section>

        <!-- 2. PREVIEW & GENERATE STATE -->
        <section id="preview-section" class="hidden text-center space-y-6 animate-pop-in">
            <p class="text-xl font-semibold text-gray-800">Your Image</p>
            <div class="flex justify-center">
                <img id="image-preview" src="" alt="Image preview" class="max-h-80 w-auto rounded-xl shadow-lg" />
            </div>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="change-image-btn" type="button" class="w-full sm:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105">
                    Change Image
                </button>
                <button id="generate-btn" type="button" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all flex items-center justify-center gap-2 transform hover:scale-105 duration-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.636 6.364l-.707-.707M12 21v-1m6.364-6.364l.707.707M6.343 6.343l.707.707"></path></svg>
                    Generate Caption
                </button>
            </div>
        </section>
        
        <!-- 3. LOADING STATE -->
        <section id="loading-section" class="hidden text-center space-y-4 py-12 animate-pop-in">
            <div class="flex justify-center items-center">
                <div class="spinner w-12 h-12 border-4 border-t-4 border-gray-200 rounded-full"></div>
            </div>
            <p class="text-xl font-medium text-gray-700 animate-pulse">Generating caption...</p>
            <p class="text-gray-500">This may take a moment.</p>
        </section>

        <!-- 4. RESULTS STATE -->
        <section id="results-section" class="hidden space-y-6 animate-pop-in">
            <h2 class="text-3xl font-bold text-center text-gray-900">Generated Caption</h2>
            
            <!-- --- Centered single card --- -->
            <div class="flex justify-center" id="caption-grid">

                <!-- The final caption card -->
                <!-- --- FIX: Changed the note to a proper HTML comment --- -->
                <div class="caption-card bg-gray-50 border-l-4 border-green-500 p-6 rounded-xl shadow-lg w-full transition-all duration-300 transform hover:scale-105 hover:shadow-2xl cursor-pointer">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3 text-center">üéØ AI Generated Caption</h3>
                    <p id="caption-greedy" class="text-2xl text-gray-900 font-semibold text-center italic">...</p>
                    <!-- Note: The 'hover:scale-105' will make it grow, and 'hover:shadow-2xl' will make the shadow pop. 'transition-all duration-300' makes it a smooth animation. -->
                </div>
                
            </div>

            <div class="flex justify-center pt-4">
                <button id="try-another-btn" type="button" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105">
                    Try Another Image
                </button>
            </div>
            
            <!-- Button to re-try if generation fails -->
            <div id="retry-footer" class="hidden flex justify-center pt-4">
                <button id="retry-btn" type="button" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105">
                    Try Again
                </button>
            </div>
        </section>

        <footer class="text-center mt-8">
            <p class="text-sm text-gray-500">Powered by VGG16 + LSTM | Built with Flask</p>
        </footer>
    </main>


    <!-- JAVASCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const uploadSection = document.getElementById('upload-section');
            const previewSection = document.getElementById('preview-section');
            const loadingSection = document.getElementById('loading-section');
            const resultsSection = document.getElementById('results-section');
            
            const dropZone = document.getElementById('drop-zone');
            const fileUpload = document.getElementById('file-upload');
            const imagePreview = document.getElementById('image-preview');
            
            const generateBtn = document.getElementById('generate-btn');
            const changeImageBtn = document.getElementById('change-image-btn');
            const tryAnotherBtn = document.getElementById('try-another-btn');
            const retryBtn = document.getElementById('retry-btn');
            const retryFooter = document.getElementById('retry-footer');

            const errorBox = document.getElementById('error-box');
            const errorMessage = document.getElementById('error-message');
            
            const captionGrid = document.getElementById('caption-grid');

            const captionGreedy = document.getElementById('caption-greedy');

            let currentFile = null;

            function showSection(section) {
                uploadSection.classList.add('hidden');
                previewSection.classList.add('hidden');
                loadingSection.classList.add('hidden');
                resultsSection.classList.add('hidden');
                retryFooter.classList.add('hidden');
                section.classList.remove('hidden');
            }

            function showError(message) {
                errorMessage.textContent = message || 'An unknown error occurred.';
                errorBox.classList.remove('hidden');
            }

            function hideError() {
                errorBox.classList.add('hidden');
            }

            function resetCaptionText() {
                captionGreedy.textContent = '...';
            }

            function handleFileSelect(file) {
                if (!file || !file.type.startsWith('image/')) {
                    showError('Please select a valid image file (PNG, JPG, GIF).');
                    return;
                }
                
                if (file.size > 16 * 1024 * 1024) {
                    showError('File is too large. Maximum size is 16MB.');
                    return;
                }

                currentFile = file;
                hideError();
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
                
                showSection(previewSection);
            }

            fileUpload.addEventListener('change', (e) => {
                handleFileSelect(e.target.files[0]);
            });

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('drag-over');

            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');
                handleFileSelect(e.dataTransfer.files[0]);
            });

            changeImageBtn.addEventListener('click', () => {
                currentFile = null;
                fileUpload.value = null; 
                showSection(uploadSection);
                hideError();
            });

            tryAnotherBtn.addEventListener('click', () => {
                currentFile = null;
                fileUpload.value = null;
                showSection(uploadSection);
                hideError();
                resetCaptionText();
                captionGrid.classList.remove('hidden');
            });

            retryBtn.addEventListener('click', () => {
                handleGenerate(); 
            });

            generateBtn.addEventListener('click', handleGenerate);

            async function handleGenerate() {
                if (!currentFile) {
                    showError('No file selected.');
                    return;
                }

                showSection(loadingSection);
                hideError();
                captionGrid.classList.remove('hidden'); 

                const formData = new FormData();
                formData.append('image', currentFile);

                try {
                    const response = await fetch('/generate-caption', {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) {
                        let errorMsg = `Server error: ${response.status} ${response.statusText}`;
                        try {
                            const errorData = await response.json();
                            errorMsg = errorData.error || errorMsg;
                        } catch (e) {
                            // Ignore if response is not JSON
                        }
                        throw new Error(errorMsg);
                    }

                    const data = await response.json();

                    if (data.success && data.captions) {
                        captionGreedy.textContent = `"${data.captions.greedy || 'N/A'}"`;
                        
                        showSection(resultsSection);
                    } else {
                        throw new Error(data.error || 'Failed to generate captions.');
                    }

                } catch (error) {
                    console.error('Generation error:', error);
                    showError(error.message);
                    showSection(resultsSection);
                    retryFooter.classList.remove('hidden');
                    captionGrid.classList.add('hidden');
                }
            }
        });
    </script>
</body>
</html>
